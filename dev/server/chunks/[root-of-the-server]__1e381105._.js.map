{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/phuonghuupham/Documents/GitHub/Pathfinity/app/db/schema.ts"],"sourcesContent":["import {\n  boolean,\n  pgTable,\n  text,\n  timestamp,\n  serial,\n  vector,\n  index,\n  jsonb,\n} from \"drizzle-orm/pg-core\";\n\n/* User / Auth */\nexport const user = pgTable(\"users\", {\n  id: text(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  email: text(\"email\").notNull().unique(), \n  emailVerified: boolean(\"email_verified\"),\n  image: text(\"image\"),\n  password: text(\"password\"), // Add password field for email authentication\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const session = pgTable(\"sessions\", {\n  id: text(\"id\").primaryKey(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  token: text(\"token\").notNull().unique(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  userId: text(\"user_id\").notNull().references(() => user.id, { onDelete: \"cascade\" }),\n});\n\nexport const account = pgTable(\"accounts\", {\n  id: text(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull().references(() => user.id, { onDelete: \"cascade\" }),\n  accountId: text(\"account_id\").notNull(),\n  providerId: text(\"provider_id\").notNull(),\n  accessToken: text(\"access_token\"),\n  refreshToken: text(\"refresh_token\"),\n  accessTokenExpiresAt: timestamp(\"access_token_expires_at\"),\n  refreshTokenExpiresAt: timestamp(\"refresh_token_expires_at\"),\n  scope: text(\"scope\"),\n  idToken: text(\"id_token\"),\n  password: text(\"password\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const verification = pgTable(\"verifications\", {\n  id: text(\"id\").primaryKey(),\n  identifier: text(\"identifier\").notNull(),\n  value: text(\"value\").notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").notNull(),\n});\n\n/* RAG (Retrieval-Augmented Generation) tables */\n\n// Sources represent the origin of documents (files, URLs, datasets)\nexport const source = pgTable(\"sources\", {\n  id: text(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  url: text(\"url\"),\n  type: text(\"type\").notNull(), // e.g. 'json-file', 'api'\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Embeddings: store only the embeddings and minimal metadata, linked to a source.\nexport const embedding = pgTable(\"embeddings\", {\n  id: serial(\"id\").primaryKey(),\n  sourceId: text(\"source_id\").notNull().references(() => source.id, { onDelete: \"cascade\" }),\n  refId: text(\"ref_id\"),              // record ID in source (e.g., courseCode)\n  title: text(\"title\"),               // human-readable title\n  campus: text(\"campus\"),             // optional display info\n  courseCode: text(\"course_code\"),    // optional for courses\n  content: text(\"content\"),           // the text used to create embedding\n  metadata: jsonb(\"metadata\"),        // store the full original object\n  contentHash: text(\"content_hash\"),  // optional deduplication\n  embedding: vector(\"embedding\", { dimensions: 1536 }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n  },\n  (table) => [\n    index(\"embedding_vector_idx\").using(\"ivfflat\", table.embedding.op(\"vector_cosine_ops\")),\n  ]\n);"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///Users/phuonghuupham/Documents/GitHub/Pathfinity/app/db/index.ts"],"sourcesContent":["import { neon } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-http';\nimport { config } from 'dotenv';\n\nimport * as schema from './schema';\n\nconfig({ path: '.env' });\n\nconst sql = neon(process.env.DATABASE_URL as string);\nexport const db = drizzle(sql, { schema });"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAEA;;;;;AAEA,IAAA,iJAAM,EAAC;IAAE,MAAM;AAAO;AAEtB,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;AAClC,MAAM,KAAK,IAAA,qKAAO,EAAC,KAAK;IAAE,QAAA;AAAO","debugId":null}},
    {"offset": {"line": 183, "column": 0}, "map": {"version":3,"sources":["file:///Users/phuonghuupham/Documents/GitHub/Pathfinity/lib/embeddings.ts"],"sourcesContent":["// Lightweight wrapper helpers for generating embeddings via OpenAI.\n// - `generateEmbedding` creates a single embedding for a text string.\n// - `generateEmbeddings` batches multiple inputs for faster ingestion.\n// These helpers centralize model selection and minor input normalization.\nimport { embed, embedMany } from 'ai';\nimport { openai } from '@ai-sdk/openai'\n\nexport async function generateEmbedding(text: string) {\n    const input = text.replace(\"\\n\", \" \");\n\n    const { embedding } = await embed({\n        model: openai.textEmbeddingModel('text-embedding-3-small'),\n        value: input,\n    });\n\n    return embedding;\n}\n\nexport async function generateEmbeddings(texts: string[]) {\n    const inputs = texts.map((text) => text.replace(\"\\n\", \" \"));\n\n    const { embeddings } = await embedMany({\n        model: openai.textEmbeddingModel('text-embedding-3-small'),\n        values: inputs,\n    });\n\n    return embeddings;\n}"],"names":[],"mappings":"AAAA,oEAAoE;AACpE,sEAAsE;AACtE,uEAAuE;AACvE,0EAA0E;;;;;;;AAC1E;AACA;;;AAEO,eAAe,kBAAkB,IAAY;IAChD,MAAM,QAAQ,KAAK,OAAO,CAAC,MAAM;IAEjC,MAAM,EAAE,SAAS,EAAE,GAAG,MAAM,IAAA,+JAAK,EAAC;QAC9B,OAAO,mKAAM,CAAC,kBAAkB,CAAC;QACjC,OAAO;IACX;IAEA,OAAO;AACX;AAEO,eAAe,mBAAmB,KAAe;IACpD,MAAM,SAAS,MAAM,GAAG,CAAC,CAAC,OAAS,KAAK,OAAO,CAAC,MAAM;IAEtD,MAAM,EAAE,UAAU,EAAE,GAAG,MAAM,IAAA,mKAAS,EAAC;QACnC,OAAO,mKAAM,CAAC,kBAAkB,CAAC;QACjC,QAAQ;IACZ;IAEA,OAAO;AACX","debugId":null}},
    {"offset": {"line": 217, "column": 0}, "map": {"version":3,"sources":["file:///Users/phuonghuupham/Documents/GitHub/Pathfinity/lib/semantic-search.tsx"],"sourcesContent":["// lib/semantic-search.tsx\n// Compute an embedding for the user query and perform a cosine-similarity\n// lookup against the `embeddings` table using Drizzle ORM. Returns the top-N\n// similar records (with similarity score and selected metadata) for RAG.\nimport { cosineDistance, desc, gt, sql } from 'drizzle-orm';\nimport { db } from '@/app/db/index';\nimport { embedding as e, source as s } from '@/app/db/schema';\nimport { generateEmbedding } from './embeddings';\n\nexport async function semanticSearch(\n    query: string,\n    limit: number = 5,\n    threshold: number = 0.3\n) {\n    const embedding = await generateEmbedding(query);\n\n    const similarity = sql<number>`1 - (${cosineDistance(\n        e.embedding,\n        embedding\n    )})`;\n\n    const similarEmbeddings = await db\n        .select({\n            id: e.id,\n            content: e.metadata,\n            similarity,\n            source: s.name,\n            source_id: e.refId,\n            course_code: e.courseCode,\n            title: e.title,\n            campus: e.campus,\n        })\n        .from(e)\n        .leftJoin(s, sql`${e.sourceId} = ${s.id}`)\n        .where(gt(similarity, threshold))\n        .orderBy(desc(similarity))\n        .limit(limit);\n\n    return similarEmbeddings;\n}"],"names":[],"mappings":"AAAA,0BAA0B;AAC1B,0EAA0E;AAC1E,6EAA6E;AAC7E,yEAAyE;;;;;AACzE;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,eAClB,KAAa,EACb,QAAgB,CAAC,EACjB,YAAoB,GAAG;IAEvB,MAAM,YAAY,MAAM,IAAA,wIAAiB,EAAC;IAE1C,MAAM,aAAa,qJAAG,AAAQ,CAAC,KAAK,EAAE,IAAA,gLAAc,EAChD,kIAAC,CAAC,SAAS,EACX,WACF,CAAC,CAAC;IAEJ,MAAM,oBAAoB,MAAM,0HAAE,CAC7B,MAAM,CAAC;QACJ,IAAI,kIAAC,CAAC,EAAE;QACR,SAAS,kIAAC,CAAC,QAAQ;QACnB;QACA,QAAQ,+HAAC,CAAC,IAAI;QACd,WAAW,kIAAC,CAAC,KAAK;QAClB,aAAa,kIAAC,CAAC,UAAU;QACzB,OAAO,kIAAC,CAAC,KAAK;QACd,QAAQ,kIAAC,CAAC,MAAM;IACpB,GACC,IAAI,CAAC,kIAAC,EACN,QAAQ,CAAC,+HAAC,EAAE,qJAAG,CAAC,EAAE,kIAAC,CAAC,QAAQ,CAAC,GAAG,EAAE,+HAAC,CAAC,EAAE,CAAC,CAAC,EACxC,KAAK,CAAC,IAAA,0KAAE,EAAC,YAAY,YACrB,OAAO,CAAC,IAAA,wKAAI,EAAC,aACb,KAAK,CAAC;IAEX,OAAO;AACX","debugId":null}},
    {"offset": {"line": 255, "column": 0}, "map": {"version":3,"sources":["file:///Users/phuonghuupham/Documents/GitHub/Pathfinity/app/api/chat/route.ts"],"sourcesContent":["// Chat API route for the university course assistant.\n// Defines tools used by the assistant:\n// The file contains the system prompt and streaming response wiring.\nimport { \n    streamText,\n    UIMessage,\n    convertToModelMessages,\n    tool,\n    InferUITools,\n    UIDataTypes,\n    stepCountIs\n} from 'ai';\nimport { openai } from '@ai-sdk/openai';\nimport { z } from 'zod';\nimport { semanticSearch } from '@/lib/semantic-search';\nimport { db } from '@/app/db/index';\nimport { embedding as e } from '@/app/db/schema';\nimport { sql } from 'drizzle-orm';\n\nconst tools = {\n    getCourseByCode: tool({\n        description: \"Get detailed information about a specific course by its exact course code (e.g., 'Com 2163', 'COM 2158'). Use this when user mentions a specific course code.\",\n        inputSchema: z.object({\n            courseCode: z.string().describe(\"The exact course code (e.g., 'Com 2163')\"),\n        }),\n        execute: async ({ courseCode }) => {\n            try {\n                // Normalize the course code (remove extra spaces, make uppercase)\n                const normalized = courseCode.trim().toUpperCase().replace(/\\s+/g, ' ');\n                \n                const course = await db\n                    .select({\n                        course_code: e.courseCode,\n                        title: e.title,\n                        campus: e.campus,\n                        metadata: e.metadata,\n                    })\n                    .from(e)\n                    .where(sql`UPPER(${e.courseCode}) = ${normalized}`)\n                    .limit(1);\n\n                if (!course || course.length === 0) {\n                    return `Course ${courseCode} not found in the knowledge base. Please verify the course code or try searching with keywords.`;\n                }\n\n                const c = course[0];\n                const metadata = c.metadata as any;\n\n                const lines = [\n                    `Course: ${c.course_code} - ${c.title}`,\n                ];\n\n                if (c.campus) lines.push(`Campus/Department: ${c.campus}`);\n                \n                // Handle credits/units (check multiple fields)\n                const units = metadata?.num_units || metadata?.units || metadata?.credits || metadata?.credit_hours;\n                if (units !== undefined && units !== null && String(units).trim() !== '') {\n                    lines.push(`Units/Credits: ${units}`);\n                } else {\n                    lines.push(`Units/Credits: Not specified`);\n                }\n                \n                if (metadata?.course_desc) lines.push(`Description: ${metadata.course_desc}`);\n                if (metadata?.metadata && String(metadata.metadata).trim()) {\n                    lines.push(`Additional Info: ${metadata.metadata}`);\n                }\n                \n                // Check for various prerequisite field names\n                const prereqs = metadata?.prerequisites || metadata?.required_prep || metadata?.required_prereq;\n                if (prereqs) lines.push(`Prerequisites: ${prereqs}`);\n\n                // Add other metadata fields if available\n                if (metadata?.dept_name) lines.push(`Department Name: ${metadata.dept_name}`);\n                if (metadata?.inst_ipeds) lines.push(`Institution IPEDS: ${metadata.inst_ipeds}`);\n                if (metadata?.course_prefix) lines.push(`Course Prefix: ${metadata.course_prefix}`);\n                if (metadata?.course_number) lines.push(`Course Number: ${metadata.course_number}`);\n\n                return lines.join('\\n\\n');\n            } catch (error) {\n                console.error('Get course error:', error);\n                return 'Error retrieving course information. Please try again.';\n            }\n        }\n    }),\n    \n    listCourses: tool({\n        description: \"List courses from the knowledge base. Use when user wants to see all courses, browse courses, or list courses from a specific department/campus.\",\n        inputSchema: z.object({\n            department: z.string().optional().describe(\"Filter by department name (e.g., 'Pacific Center for Advanced Technology Training')\"),\n            campus: z.string().optional().describe(\"Filter by campus name\"),\n            limit: z.number().optional().default(20).describe(\"Maximum number of courses to return\"),\n        }),\n        execute: async ({ department, campus, limit = 20 }) => {\n            try {\n                // Build WHERE conditions\n                const conditions = [];\n                if (department) {\n                    conditions.push(sql`${e.metadata}->>'dept_name' ILIKE ${`%${department}%`}`);\n                }\n                if (campus) {\n                    conditions.push(sql`${e.campus} ILIKE ${`%${campus}%`}`);\n                }\n\n                const baseSelect = db\n                    .select({\n                        course_code: e.courseCode,\n                        title: e.title,\n                        campus: e.campus,\n                        metadata: e.metadata,\n                    })\n                    .from(e);\n\n                // Apply WHERE conditions if present, then apply limit/orderBy on the final query.\n                const finalQuery = (conditions.length > 0)\n                    ? baseSelect.where(sql`${sql.join(conditions, sql` AND `)}`).limit(limit).orderBy(e.courseCode)\n                    : baseSelect.limit(limit).orderBy(e.courseCode);\n\n                const courses = await finalQuery;\n\n                if (!courses || courses.length === 0) {\n                    return 'No courses found matching those criteria.';\n                }\n\n                const formattedResults = courses.map((course, index) => {\n                    const metadata = course.metadata as any;\n                    const lines = [\n                        `[${index + 1}] ${course.course_code} - ${course.title}`,\n                    ];\n                    \n                    if (course.campus) lines.push(`   Campus/Department: ${course.campus}`);\n                    \n                    // Handle credits/units with fallback\n                    const units = metadata?.num_units || metadata?.units || metadata?.credits;\n                    if (units !== undefined && units !== null && String(units).trim() !== '') {\n                        lines.push(`   Units: ${units}`);\n                    }\n                    \n                    if (metadata?.course_desc) {\n                        const desc = String(metadata.course_desc);\n                        const truncated = desc.length > 200 ? desc.substring(0, 200) + '...' : desc;\n                        lines.push(`   Description: ${truncated}`);\n                    }\n                    \n                    return lines.join('\\n');\n                }).join('\\n\\n');\n\n                return formattedResults;\n            } catch (error) {\n                console.error('List courses error:', error);\n                return 'Error retrieving course list. Please try again.';\n            }\n        }\n    }),\n    \n    searchKnowledgeBase: tool({\n        description: \"Search the course knowledge base for specific courses or topics. Use when user asks about specific course codes, prerequisites, topics, or detailed course information.\",\n        inputSchema: z.object({\n            query: z.string().describe(\"The search query to find relevant information\"),\n        }),\n        execute: async ({ query }) => {\n            try {\n                const results = await semanticSearch(query, 5, 0.3);\n\n                if (!results || results.length === 0) {\n                    return 'No relevant course information found. Try rephrasing your question or ask about a specific course code.';\n                }\n\n                const formattedResults = results.map((result: any, index: number) => {\n                    // Build header with source info\n                    const headerParts = [`[${index + 1}]`];\n                    if (result.source) headerParts.push(result.source);\n                    if (result.course_code) headerParts.push(result.course_code);\n                    const header = headerParts.join(' | ');\n\n                    const content = result.content;\n\n                    // Helper function to extract fields from object\n                    const pick = (obj: any, candidates: string[]) => {\n                        for (const k of candidates) {\n                            if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') {\n                                return obj[k];\n                            }\n                        }\n                        return undefined;\n                    };\n\n                    // Handle different content types\n                    if (typeof content === 'string') {\n                        return `${header}\\n${content.trim()}`;\n                    }\n\n                    if (Array.isArray(content)) {\n                        const body = content\n                            .map((c) => (typeof c === 'string' ? c : JSON.stringify(c)))\n                            .join('\\n');\n                        return `${header}\\n${body}`;\n                    }\n\n                    if (content && typeof content === 'object') {\n                        // Extract course fields\n                        const courseCode = pick(content, ['course_code', 'course', 'courseId', 'course_num', 'course_number', 'code']);\n                        const coursePrefix = pick(content, ['course_prefix']);\n                        const courseNumber = pick(content, ['course_number']);\n                        const title = pick(content, ['course_title', 'title', 'name']);\n                        const dept = pick(content, ['dept_name', 'department', 'dept', 'division']);\n                        const units = pick(content, ['num_units', 'units', 'credits', 'credit_hours']);\n                        const desc = pick(content, ['course_desc', 'description', 'desc', 'summary', 'overview']);\n                        const metadata = pick(content, ['metadata', 'additional_info', 'additional', 'notes']);\n                        const outcomes = pick(content, ['learner_outcomes', 'outcomes', 'learning_outcomes']);\n                        const prereqs = pick(content, ['prerequisites', 'required_prep', 'required_prereq', 'prereq']);\n                        const sectionNotes = pick(content, ['section_notes', 'sectionNotes', 'section', 'section_note']);\n\n                        const lines: string[] = [];\n\n                        // Course code line\n                        const courseCodeParts: string[] = [];\n                        if (courseCode) {\n                            courseCodeParts.push(String(courseCode));\n                        } else if (coursePrefix && courseNumber) {\n                            courseCodeParts.push(`${coursePrefix} ${courseNumber}`);\n                        }\n                        if (title) courseCodeParts.push(String(title));\n                        if (courseCodeParts.length) {\n                            lines.push(`Course: ${courseCodeParts.join(' - ')}`);\n                        }\n\n                        // Other fields\n                        if (dept) lines.push(`Department: ${String(dept)}`);\n                        if (units !== undefined) lines.push(`Units: ${String(units)}`);\n                        if (desc) lines.push(`Description: ${String(desc)}`);\n                        if (metadata) lines.push(`Additional Info: ${String(metadata)}`);\n                        \n                        // Handle outcomes (array or string)\n                        if (Array.isArray(outcomes)) {\n                            lines.push(`Learner Outcomes:\\n${outcomes.map(o => `  â€¢ ${o}`).join('\\n')}`);\n                        } else if (outcomes) {\n                            lines.push(`Learner Outcomes: ${String(outcomes)}`);\n                        }\n                        \n                        if (prereqs) lines.push(`Prerequisites: ${String(prereqs)}`);\n                        if (sectionNotes) lines.push(`Section Notes: ${String(sectionNotes)}`);\n\n                        // Fallback if no structured fields found\n                        if (lines.length === 0) {\n                            const fallback = pick(content, ['text', 'content', 'snippet']) || JSON.stringify(content, null, 2);\n                            return `${header}\\n${String(fallback)}`;\n                        }\n\n                        return `${header}\\n${lines.join('\\n')}`;\n                    }\n\n                    // Last resort: stringify\n                    return `${header}\\n${JSON.stringify(content)}`;\n                }).join('\\n\\n');\n\n                return formattedResults;\n            } catch (error) {\n                console.error('Search error:', error);\n                return 'Error searching the course knowledge base. Please try again or refine your query.';\n            }\n        }\n    })\n};\n\nexport type ChatTools = InferUITools<typeof tools>;\nexport type ChatMessage = UIMessage<never, UIDataTypes, ChatTools>;\n\nexport async function POST(req: Request) {\n    try {\n        const { messages }: { messages: ChatMessage[] } = await req.json();\n\n        const result = streamText({\n            model: openai('gpt-4.1-mini'),\n            messages: convertToModelMessages(messages),\n            tools,\n            system: `You are a helpful university course assistant with access to the course knowledge base.\n\nHOW TO RESPOND:\n\nFor greetings and casual conversation:\n- Respond naturally and briefly, then offer to help with courses\n- Example: \"Hello! I'm doing well, thank you. I'm here to help you find course information. What courses are you interested in?\"\n\nFor specific course code lookups:\n- Use getCourseByCode when user mentions a specific course code (e.g., \"Com 2163\", \"tell me about COM 2158\")\n- This guarantees finding the course if it exists and returns ALL metadata fields\n- Use for questions about specific fields: credits, IPEDS, department name, course prefix/number\n- Example: \"Com 2163\", \"what is COM 2158\", \"credits for Com 2187\", \"what is the IPEDS for Com 2036\"\n\nFor listing/browsing courses:\n- Use listCourses tool for requests like \"list all courses\", \"show me courses\", \"what courses are available\"\n- Can filter by department or campus if user specifies\n- Present results in a clear, organized way\n- If many results, suggest being more specific\n- IMPORTANT: Only call this tool ONCE per response - do not repeat calls\n\nFor specific course searches:\n- Use searchKnowledgeBase for topic-based searches, not exact course codes\n- Examples: \"AWS courses\", \"courses about networking\", \"cybersecurity training\"\n- Always cite results with [1], [2], etc.\n\nFor course-related questions:\n- Choose the appropriate tool based on the question type\n- getCourseByCode: When user asks about a specific course code or its attributes\n- listCourses: When user wants to browse or see multiple courses\n- searchKnowledgeBase: When user searches by topic/keyword\n- If results found: Answer concisely with citations when appropriate\n- If no results: Explain you couldn't find that specific information and suggest alternatives\n\nIMPORTANT RULES:\n- When asked about credits/units for a course, use getCourseByCode to get complete info\n- If credits are \"Not specified\", clearly state that\n- For metadata fields (IPEDS, dept_name, etc.), use getCourseByCode\n- Never call the same tool twice in one response\n- Be conversational and helpful, not robotic\n\nFor non-course questions (sports, weather, celebrities, general facts):\n- Politely decline and redirect to course information\n- Example: \"I can only help with course information from our catalog. I don't have access to information about sports teams or other topics. Is there a course or program I can help you find?\"\n\nRULES:\n- Always use tools for course-related questions\n- Choose the RIGHT tool: getCourseByCode for specific codes, listCourses for browsing, searchKnowledgeBase for topics\n- NEVER call the same tool multiple times in one response\n- Be conversational and helpful, not robotic\n- Cite sources with [1], [2] when providing course information from searchKnowledgeBase\n- Keep responses concise (2-5 sentences typically)\n- Guide users toward more specific queries if their question is too broad\n- When credits/units are not available, clearly state \"Not specified\" rather than saying you can't find the info`,\n            stopWhen: stepCountIs(2),\n        });\n\n        return result.toUIMessageStreamResponse();\n    } catch (error) {\n        console.error('Error streaming chat completion:', error);\n        return new Response('Failed to stream chat completion', { status: 500 });\n    }\n}"],"names":[],"mappings":"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","debugId":null}}]
}